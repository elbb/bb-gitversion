<img src="https://raw.githubusercontent.com/elbb/bb-buildingblock/master/.assets/logo.png" height="200">

# Concourse pipeline integration guide

**Before continue reading please make sure that you don't use the `pipeline.yaml` as a base to work on. Instead use the `example/ci/pipeline.yaml` as base file for your integration.**

For using this concourse CI pipeline it is recommended to have two config files:

-   `config.yaml`: for production purposes
-   `config.local.yaml`: for development and testing purposes

The `config.yaml` is used to access the projects production release repository and branch and a real cloud S3 endpoint to store version artifacts.
The `config.local.yaml` is used to develop and test the pipeline for building blocks. It is used to work with your private fork or local git repository, your local docker registry as well as a local S3 endpoint.

# Example concourse CI pipeline

This example is intended to show the integration of a build pipeline in a derived building block.

## Adaptions for your building block

This section describes what needs to be done within the several files. 
**Note: `credentials.yaml` is ignored by `.gitignore` and will not be checked in.**

### config.yaml

Open the `config.yaml` and specify the fields that are described.
This config file shows an example for a fictive building block called `bb-example`.

Note 1: If you are using a real S3 endpoint you should enter those data. If you are using the local test environment specify like below.
Note 2: If you are using e.g. dockerhub as destination, you can specify `bb_destination: elbb/bb-example`
Note 3: If you are running the local docker registry, you might add this to the `bb_destination_insecure_registries` section. If you are using e.g. dockerhub or another ssl featured registry you can leave the brackets empty. e.g. `bb_destination_insecure_registries: []`.

    ---
    # General stuff
    # -------------
    ## Specifies the name of the building block
    bb_name: bb-example
    ## Specifies the destination of the docker image artifact
    # Using local environment for docker registry
    bb_destination: registry:5000/elbb/bb-example
    ## Specifies insecure docker registries, format "host:port" or "ip:port"
    bb_destination_insecure_registries: ["registry:5000"]

    # Versioning stuff
    # ----------------
    ## Specifies the version used for bb-gitversion
    bb_gitversion_version: 0.3.0

    # Git relevant stuff
    # ------------------
    ## Specify the git repository to work with
    git_source: https://github.com/elbb/bb-example.git
    ## Specify the git branch to work with
    git_branch: example
    ## This enables/disables ssl verification of the git resource
    git_skip_ssl_verification: false

    # S3 relevant stuff
    # -----------------
    ## Specify the S3 endpoint URI
    # Using local environment for min.io
    s3_endpoint: http://minio:9000
    ## This enables/disables the ssl verification for the S3 endpoint
    s3_skip_ssl_verification: true

### credentials.yaml

**Note: Make sure that you have set up ssh access with your ssh-key in your git repository.**

Fill in your ssh private key and your S3 credentials in `credentials.example.yaml` and rename it to `credentials.yaml`.

### pipeline.yaml

We assume that the git repository for bb-example contains parts the following file structure:

    .
    ├── docker
    |   ├── Dockerfile

As a build artifact a docker image is wanted versioned with bb-gitversion.

The example builds the docker image with the Dockerfile located in `docker/Dockerfile` and creates a tag generated by a previous step running `bb-gitversion`.

Adapt the last section in the `pipeline.yaml` to match your needs. The `image-((bb_name))` will be called `image-bb-example` and is needed to define the target docker image. The name and destination is configured in `config.yaml`. This image section does not need to be modified. But you might to modify the job called `Create docker image for ((bb_name)) and push it`.
The only two parts you need to modify are in the last task `put: image-((bb_name))` 

-   `build` (docker build context) 
-   `dockerfile` (location of your Dockerfile). 

If you want your image to be tagged as `latest` keep the value at `true`, otherwise switch to `false`.

`source` specifies the root of your checked out git repository and does not need to be adapted.

    resources:
    ...
      - name: image-((bb_name))
        type: docker-image
        source:
          repository: ((bb_destination))
          tag: latest
    ...
    jobs:
    ...
      - name: Create docker image for ((bb_name)) and push it
        public: true
        plan:
          - in_parallel:
              - get: source
              - get: s3-gitversion
                trigger: true
                params:
                  unpack: true
          - put: image-((bb_name))
            params:
              build: source/docker
              dockerfile: source/docker/Dockerfile
              additional_tags: s3-gitversion/plain/SemVer
              tag_as_latest: true

Note: If the S3 bucket does not exist, it will be created with the generated version as suffix `<bb_name>-<SemVer>` e.g. `bb-example-0.1.0`.

## Using the pipeline

Use `fly` to setup the pipeline with concourse CI.
Before setting the pipeline you might login first to your concourse instance `fly -t <target> login --concourse-url http://<concourse>:<port>`. See the [fly documentation](https://concourse-ci.org/fly.html) for more help.

Once you've setup your concourse CI server (either hosted or local) upload the pipeline:

    $ cd example/ci
    $ fly -t <target> set-pipeline -n -p bb-example -l ci/config.yaml -l ci/credentials.yaml -c pipeline.yaml

If your build succeeds, overwrite the the `pipeline.yaml` and `ci/` with your modified pipeline from `example/ci`. You are free to remove `example/ci`.

```

```
